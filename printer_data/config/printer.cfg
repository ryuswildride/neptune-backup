#----------------------------------------------------------------------------
#      ____                _  __         __  ____              
#     / __ \___  ___ ___  / |/ /__ ___  / /_/ / /__ _____  ___ 
#    / /_/ / _ \/ -_) _ \/    / -_) _ \/ __/_  _/ // / _ \/ -_)
#    \____/ .__/\__/_//_/_/|_/\__/ .__/\__/ /_/ \_,_/_//_/\__/ 
#        /_/                    /_/                            
#----------------------------------------------------------------------------
;   Neptune 4 Series Custom Image by (OpenNeptune3D/OpenNept4une):
#----------------------------------------------------------------------------
; Wiki    : https://github.com/OpenNeptune3D/OpenNept4une/wiki
; Discord : https://discord.com/invite/X6kwchT6WM

#############################################################################
#   External Config Includes
#############################################################################
[include mainsail.cfg]          ; mainsail runs on port 81 (http://IP_ADDRESS:81)
[include fluidd.cfg]
[include KAMP_Settings.cfg]
[include ./KAMP/Smart_Park.cfg]
[include ./KAMP/Line_Purge.cfg]
[auto_speed]
[skew_correction]
[include song.cfg]
#[include klipper_debug.cfg]
#[include adxl.cfg]             ; Comment this out when you disconnect the Pico/MellowFly

#############################################################################
#   Base Config
#############################################################################

[mcu]
serial: /dev/ttyS0 ; The hardware use USART1 PA10/PA9 connect to RK3328
baud: 250000
restart_method: command

[printer]
kinematics:cartesian
max_velocity: 400
max_accel: 4000
max_z_velocity: 8
max_z_accel: 120
square_corner_velocity: 5.0
minimum_cruise_ratio: 0.0

[respond]
[gcode_arcs]
[pause_resume]
[display_status]
[exclude_object]
[firmware_retraction]
[virtual_sdcard]
path: ~/printer_data/gcodes
[force_move]
enable_force_move : True
[idle_timeout]
timeout: 2100                  ; 35min idle timeout (when not paused or printing)

#############################################################################
#   Print Start & End Macros
#############################################################################

[gcode_macro PRINT_START]   
gcode:
    Frame_Light_ON
    Part_Light_ON
    G92 E0 
    G90                       ; Use absolute coordinates
    BED_MESH_CLEAR    
  
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set BED_MESH = params.BED_MESH|default('adaptive')|string %} ; One of: adaptive (default), full, default (or any other value as the bed mesh profile name), none
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(200)|float %}


    SET_BED_TEMPERATURE TARGET={BED_TEMP}                           ; Heat Bed to target temp
    BED_TEMPERATURE_WAIT MINIMUM={BED_TEMP-1} MAXIMUM={BED_TEMP+4}  ; Waits until the bed reaches close to target

    CG28
    #Skew_profile load=CaliFlower
    #Skew_profile load=CaliLantern
    #Skew_profile load=lantern_profile_1

    {% if BED_MESH == 'full' %}
    BED_MESH_CALIBRATE METHOD=rapid_scan
    {% elif BED_MESH == 'adaptive' %}
    BED_MESH_CALIBRATE ADAPTIVE=1 METHOD=rapid_scan
    {% elif BED_MESH != 'none' %}
    BED_MESH_PROFILE LOAD={BED_MESH}
    {% endif %}
    Smart_Park
    SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=1
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={EXTRUDER_TEMP}   ; Set and heat the final extruder temperature
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={EXTRUDER_TEMP-4} MAXIMUM={EXTRUDER_TEMP+10}  ; Wait for extruder to reach near target temperature
    LINE_PURGE                                                      ; KAMP Line Purge near print
    G92 E0                                                          ; Reset Extruder
    G1 Z2.0 F3000                                                   ; Move Z Axis up 
    M117 Printing           
       
[gcode_macro PRINT_END]
gcode:
    Frame_Light_OFF
    Part_Light_OFF
    M400                    ; wait for buffer to clear
    TURN_OFF_HEATERS
    G92 E0                  ; zero the extruder
    G91                     ; Relative positioning
    G1 E-2 F2700            ; Retract a bit
    G1 X5 Y5 F3000          ; Wipe out
    G1 E-2 Z0.2 F1600       ; Retract and raise Z
    G1 Z4 F3000             ; Raise Z more
    G90                     ; Absolute positioning
    G1 X10 Y300              ; Present print
    M107                    ; turn off fan
    M84                     ; turn off steppers
    SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=0
    M117
    SET_SKEW CLEAR=1
    END_TUNE                ; Print End Beeper Jingle

#############################################################################
#   Pause, Resume & Cancel Macros
#############################################################################

[gcode_macro PAUSE]
rename_existing: BASE_PAUSE
gcode:
  PAUSE_TUNE
  {% set z = params.Z|default(30)|int %}                                                   ; z hop amount 30mm
  {% if printer['pause_resume'].is_paused|int == 0 %}
      SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=zhop VALUE={z}                              ; set z hop variable for reference in resume macro
      SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=etemp VALUE={printer['extruder'].target}    ; set hotend temp variable for reference in resume macro
      SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=0                                  ; disable filament sensor
      SAVE_GCODE_STATE NAME=PAUSE                                                          ; save the current print position for resume, before z-hop
      BASE_PAUSE                                                                           ; pause print
      G91                                                                           
      {% if (printer.gcode_move.position.z + z) < printer.toolhead.axis_maximum.z %}       ; check that zhop doesn't exceed z max
          G1 E-2 F2700                                                                     ; Retract 2mm
          G1 X3 Y3 F3000                                                                   ; Wipe out 
          G1 E-2 Z{z} F1600                                                                ; Retract 2mm more & raise z by z hop amount 
          SAVE_GCODE_STATE NAME=ZLIFT                                                      ; save the current print position for resume, after z-hop
      {% else %}
          { action_respond_info("Pause zhop exceeds maximum Z height.") }                  ; if z max is exceeded, show message and set zhop value for resume to 0
          SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=zhop VALUE=0
          G1 E-2 F2700                                                                     ; Retract 2mm
          G1 X3 Y3 F3000                                                                   ; Wipe out 
          G1 E-2 F1600                                                                     ; Retract 2mm more
          SAVE_GCODE_STATE NAME=ZLIFT
      {% endif %}
      G90
      G1 X{printer.toolhead.axis_minimum.x+5} Y{printer.toolhead.axis_maximum.y-5} F6000   ; park toolhead at the rear left of the bed
      SAVE_GCODE_STATE NAME=PAUSEPARK                                                      ; save the parked position
      SET_HEATER_TEMPERATURE HEATER=extruder TARGET=160                                    ; cool down hotend to no-drip temp
      SET_IDLE_TIMEOUT TIMEOUT=43200                                                       ; set idle timeout to 12 hours (in seconds)
  {% endif %}

[gcode_macro RESUME]
rename_existing: BASE_RESUME
variable_zhop: 0
variable_etemp: 0
gcode:
  {% if printer['pause_resume'].is_paused|int == 1 %}
      SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=1                           ; enable filament sensor
      SET_IDLE_TIMEOUT TIMEOUT={printer.configfile.settings.idle_timeout.timeout}   ; set timeout back to configured value
      {% if etemp > 0 %}
          SET_HEATER_TEMPERATURE HEATER=extruder TARGET={etemp|int}
          TEMPERATURE_WAIT SENSOR=extruder MINIMUM={etemp|int - 4} MAXIMUM={etemp|int + 10}  ; wait for hotend to heat back up to print temp
      {% endif %}
      RESTORE_GCODE_STATE NAME=PAUSEPARK MOVE=1 MOVE_SPEED=100                      ; go back to park position in case toolhead was moved during pause                                                                        ; enable extruder stepper motor
      G91                                                                           ; relative positioning
      M83                                                                           ; set extruder to relative mode
      G1 E80  F200                                                                  ; extrude 80mm of filament to prime the nozzle
      G4 P2000                                                                      ; wait for 2 seconds to stabilise pressure
      G1 X20 F15000                                                                 ; wiggle movement to ensure free movement of purge
      G1 X-20
      G1 X20
      G1 X-20
      G1 X20
      G1 X-20
      RESTORE_GCODE_STATE NAME=ZLIFT MOVE=1 MOVE_SPEED=60                           ; restore to the zlift position above the print
      G1 X-3 Y-3 F3000                                                              ; Undo the pause Wipe out 
      G1 Z{zhop * -1} F900  
      RESTORE_GCODE_STATE NAME=PAUSE MOVE=1 MOVE_SPEED=60                           ; restore to the paused position (lowers to final print location)
      M400                                                                          ; wait for all moves to complete
      BASE_RESUME                                                                   ; resume print
  {% endif %}

[gcode_macro CANCEL_PRINT]
rename_existing: BASE_CANCEL_PRINT
gcode:
  SET_IDLE_TIMEOUT TIMEOUT={printer.configfile.settings.idle_timeout.timeout}      ; set timeout back to configured value
  CLEAR_PAUSE
  SDCARD_RESET_FILE
  PRINT_END
  BASE_CANCEL_PRINT

#############################################################################
#   Filament Sensor & Change Macros
#############################################################################

[filament_switch_sensor filament_sensor]
pause_on_runout: True
insert_gcode:
    M117 Insert Detected
runout_gcode:
    M117 Runout Detected
    UNLOAD_FILAMENT
event_delay: 3.0
pause_delay: 1.0
switch_pin: PA12

[delayed_gcode DISABLE_FILAMENT_SENSOR]
initial_duration: 1
gcode:
    SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=0

[gcode_macro M600]
description: Pause for colour change
gcode:
  PAUSE
  UNLOAD_FILAMENT

[gcode_macro LOAD_FILAMENT]
variable_load_distance:  25
variable_purge_distance:  30
gcode:
  SET_HEATER_TEMPERATURE HEATER=extruder TARGET=200
  TEMPERATURE_WAIT SENSOR=extruder MINIMUM={200-4} MAXIMUM={200+40}
  {% set speed = params.SPEED|default(300) %}
  {% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity  * 30 %}
  SAVE_GCODE_STATE NAME=load_state
  G91
  G92 E0
  G1 E{load_distance} F{max_velocity}          ; fast-load
  G1 E{purge_distance} F{speed}                ; purge
  RESTORE_GCODE_STATE NAME=load_state

[gcode_macro UNLOAD_FILAMENT]
variable_unload_distance:  55
variable_purge_distance:  15
gcode:
  SET_HEATER_TEMPERATURE HEATER=extruder TARGET=200
  TEMPERATURE_WAIT SENSOR=extruder MINIMUM={200-4} MAXIMUM={200+40}
  {% set speed = params.SPEED|default(300) %}
  {% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity  * 30 %}
  SAVE_GCODE_STATE NAME=unload_state
  G91
  G92 E0
  G1 E{purge_distance} F{speed}                ; purge
  G1 E-{unload_distance} F{max_velocity}       ; fast-unload
  RESTORE_GCODE_STATE NAME=unload_state

#############################################################################
#   X/Y/Z Stepper Config
#############################################################################

[stepper_x]
step_pin: PC14
dir_pin: PC13
enable_pin: !PC15
microsteps: 16
rotation_distance: 39.88
full_steps_per_rotation:200                  ; set to 400 for 0.9 degree stepper
endstop_pin: tmc2209_stepper_x:virtual_endstop
position_min: -12
position_endstop: -10
position_max: 331
homing_speed: 50
homing_retract_dist: 0
homing_positive_dir: false

[stepper_y]
step_pin: PB4
dir_pin: !PB3
enable_pin: !PC15
microsteps: 16
rotation_distance: 39.99
full_steps_per_rotation:200                  ; set to 400 for 0.9 degree stepper
endstop_pin: tmc2209_stepper_y:virtual_endstop
position_min: -2
position_endstop: 0
position_max: 330
homing_speed:50
homing_retract_dist: 0
homing_positive_dir:false

[stepper_z]
step_pin: PC10
dir_pin: !PA13
enable_pin: !PC11
microsteps: 16
rotation_distance: 8
full_steps_per_rotation: 200
endstop_pin:probe:z_virtual_endstop
position_max: 405
position_min: -5
homing_speed: 10
second_homing_speed: 3
homing_retract_dist: 5

#############################################################################
#   TMC Stepper-driver UART Config
#############################################################################

[tmc2209 stepper_x]
uart_pin: PB9
run_current: 1.0
interpolate: True
#stealthchop_threshold: 999999
stealthchop_threshold: 0
driver_SGTHRS: 90
diag_pin: ^PC0

[tmc2209 stepper_y]
uart_pin: PD2
run_current: 1.4
interpolate: True
#stealthchop_threshold: 999999
stealthchop_threshold: 0
driver_SGTHRS: 80
diag_pin: ^PB8

[tmc2209 stepper_z]
uart_pin: PC5
run_current: 0.8
hold_current: 0.5
interpolate: true

[tmc2209 extruder]
uart_pin: PC4
run_current: 0.8
interpolate: false

#############################################################################
#   Extruder Config
#############################################################################

[extruder]
step_pin:PA5
dir_pin:!PA6
enable_pin:!PA4
microsteps: 32
#rotation_distance: 28.888                     ; 31.4 Bondtech 5mm Drive Gears
rotation_distance: 29.154403
gear_ratio: 52:10
full_steps_per_rotation: 200                  ; 200 for 1.8 degree, 400 for 0.9 degree
nozzle_diameter: 0.400
filament_diameter: 1.750
min_temp: 0
max_temp: 330
heater_pin: PA7
sensor_type:NTC 100K MGB18-104F39050L32
sensor_pin: PA1
max_power: 1
#control = pid
# pid_kp = 35.144
# pid_ki = 9.762
# pid_kd = 31.630
pressure_advance: 0.018
pressure_advance_smooth_time: 0.02
max_extrude_cross_section: 5                  ; standard klipper default 4* (NozzleDiam^2)
instantaneous_corner_velocity: 5.0
max_extrude_only_distance: 100
max_extrude_only_velocity:45
max_extrude_only_accel:2000
step_pulse_duration:0.000002

[verify_heater extruder]
max_error: 30
check_gain_time: 10
hysteresis: 10
heating_gain: 2

#############################################################################
#   Bed Heater Config
#############################################################################

[heater_bed]
heater_pin:PB10
sensor_type: NTC 100K MGB18-104F39050L32
sensor_pin: PA0
max_power: 1.0
#control = pid
# pid_kp = 75.397
# pid_ki = 0.823
# pid_kd = 1727.531
min_temp: 0
max_temp: 120 
pwm_cycle_time: 0.3

[verify_heater heater_bed]
max_error: 120
check_gain_time: 120
hysteresis: 10
heating_gain: 2

[gcode_macro SET_BED_TEMPERATURE]
gcode:
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={params.TARGET}

[gcode_macro BED_TEMPERATURE_WAIT]
gcode:
    {% if params.MINIMUM is defined and params.MAXIMUM is defined %}
      TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={params.MINIMUM} MAXIMUM={params.MAXIMUM}
    {% elif params.MINIMUM is defined %}
      TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={params.MINIMUM}
    {% elif params.MAXIMUM is defined %}
      TEMPERATURE_WAIT SENSOR=heater_bed MAXIMUM={params.MAXIMUM}
    {% else %}
      RESPOND TYPE=error MSG="Error on 'BED_TEMPERATURE_WAIT': missing MINIMUM or MAXIMUM."
    {% endif %}

#############################################################################
#   Probe Config
#############################################################################

[mcu eddy]
serial: /dev/serial/by-id/usb-Klipper_rp2040_504434031049B61C-if00
restart_method: command

[probe_eddy_current btt_eddy]
sensor_type: ldc1612
#z_offset: 2.5
#i2c_address:
i2c_mcu: eddy  # This value is good for the Eddy USB but would need to be adjusted for the Eddy Coil according to the MCU you have used.
i2c_bus: i2c0f # This value is good for the Eddy USB but would need to be adjusted for the Eddy Coil according to the I2C bus you have used.
x_offset: -36#.16
y_offset: 31#.66
#data_rate: 500

[temperature_sensor btt_eddy_mcu]
sensor_type: temperature_mcu # Sets the type of sensor for Klipper to read
sensor_mcu: eddy # Sets the MCU of the eddy probe tempereature sensor
min_temp: 10 # Sets the minimum tempereature for eddys tempereature sensor to operate
max_temp: 100

[temperature_probe btt_eddy]
sensor_type: Generic 3950
sensor_pin: eddy:gpio26
horizontal_move_z: 2

[gcode_macro PROBE_EDDY_CURRENT_CALIBRATE_AUTO]
gcode:
  BED_MESH_CLEAR
  G28 X Y
  G90 # Abs positioning
  G1 X{ printer.toolhead.axis_maximum.x/2 } Y{ printer.toolhead.axis_maximum.y/2 } F6000
  {% if 'z' not in printer.toolhead.homed_axes %}
    SET_KINEMATIC_POSITION Z={ printer.toolhead.axis_maximum.z-1 } # Allows the user to work it down until it touches.
  {% endif %}
#  PROBE_EDDY_CURRENT_CALIBRATE {rawparams}
  PROBE_EDDY_CURRENT_CALIBRATE CHIP=btt_eddy
  
#[probe]
#pin:^PA11
#x_offset: -24.25
#y_offset: 20.45
# z_offset = 0.0
#speed: 10.0
#samples: 3
#samples_result: median 
#sample_retract_dist: 3.0
#samples_tolerance: 0.025
#samples_tolerance_retries: 3

[bed_mesh]
speed: 200    
horizontal_move_z: 2
#mesh_min: 10,21
mesh_min: 19, 37
#mesh_max: 300.75,315.45
mesh_max: 293, 310
probe_count:10,10       
algorithm:bicubic
bicubic_tension:0.2 # (default .2)
mesh_pps: 2, 2 
#fade_start: 5.0
#fade_end: 15.0 

[save_variables]
filename: ~/printer_data/config/variables.cfg

#############################################################################
#   LED Config
#############################################################################

[output_pin Frame_Light]
pin: rpi:gpiochip2/gpio2

[output_pin Part_Light]
pin: rpi:gpiochip2/gpio15

[gcode_macro Frame_Light_ON]
gcode:
  SET_PIN PIN=Frame_Light VALUE=1

[gcode_macro Frame_Light_OFF]
gcode:
  SET_PIN PIN=Frame_Light VALUE=0

[gcode_macro Part_Light_ON]
gcode:
  SET_PIN PIN=Part_Light VALUE=1

[gcode_macro Part_Light_OFF]
gcode:
  SET_PIN PIN=Part_Light VALUE=0

#############################################################################
#   Beeper Config
#############################################################################

[pwm_cycle_time beeper]
pin: PA2
value: 0
shutdown_value: 0
cycle_time: 0.001                                   ; Default PWM frequency: 2 kHz

[gcode_macro M300]
gcode:
    {% set S = params.S|default(2000)|int %}        ; Set frequency (S), default to 2 kHz if omitted or invalid
    {% set P = params.P|default(100)|int %}         ; Set duration (P), default to 100ms if omitted or invalid
    SET_PIN PIN=beeper VALUE=0.5 CYCLE_TIME={ 1.0/S if S > 0 else 1 }       ; Activate the beeper at a 80% duty cycle
    G4 P{P}                                         ; Hold the beep for the specified duration
    SET_PIN PIN=beeper VALUE=0                      ; Turn off the beeper

[gcode_macro PAUSE_TUNE]
gcode:
    M300 S784 P300
    M300 S587 P600
    
[gcode_macro END_TUNE]
gcode:
    M300 S392 P250 
    M300 S494 P250 
    M300 S587 P250 
    M300 S523 P300 

#############################################################################
#   Fan & Temp Monitoring Config
#############################################################################

[controller_fan heatbreak+mainboard_fan]
pin: PC7
fan_speed: 1.0
idle_speed: 0.5
idle_timeout: 43200                                     ; 50% speed for 12h then OFF
shutdown_speed: 1
heater: extruder, heater_bed
stepper: stepper_x, stepper_y, stepper_z, extruder
[fan]
pin: PB7
[fan_generic fan3]
pin: PC9
[fan_generic fan4]
pin: PA8
[fan_generic fan5]
pin: PA15

[delayed_gcode start_fan_at_idle_speed]
initial_duration: 5.                                ; 5s wait after boot
gcode:
  # Gcode Hack to trigger the mainboard fan from printer boot
  SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET=1 ; bed heat to 1degC
  G4 P2000                                          ; wait 2s
  SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET=0 ; bed heat off

[temperature_sensor RockchipHost]
sensor_type: temperature_host
min_temp: 10
max_temp: 80

[temperature_sensor STM32MCU]
sensor_type: temperature_mcu
min_temp: 10
max_temp: 85

#############################################################################
#   Homing & Levelling Config/Macros
#############################################################################

[gcode_macro CG28]
gcode:
  {% if "xyz" not in printer.toolhead.homed_axes %}
      G28
  {% else %}
  {% endif %}
  
[safe_z_home]
home_xy_position: 189.25,86.55
speed: 200
z_hop: 10                 
z_hop_speed: 25

[axis_twist_compensation]
calibrate_start_x: 25
calibrate_end_x: 295
calibrate_y: 160

[gcode_macro Axis_Twist_Comp_Tune]
gcode:    
      CG28
      AXIS_TWIST_COMPENSATION_CALIBRATE

[screws_tilt_adjust]
screw1: 189.25,86.55
screw1_name: middle-front bed mount (shim adjust)
screw2: 189.25,204.55
screw2_name: middle-rear bed mount (shim adjust)
screw3: 59.75,277.05
screw3_name: rear left screw
screw4: 59.75,144.55
screw4_name: center left screw
screw5: 59.75,12.05
screw5_name: front left screw
screw6: 315.75,12.05
screw6_name: front right screw
screw7: 315.75,144.55
screw7_name: center right screw
screw8: 315.75,277.05
screw8_name: rear right screw
horizontal_move_z: 5
speed: 200
screw_thread: CW-M4

[gcode_macro Bed_Level_Screws_Tune]
gcode:
      BED_MESH_CLEAR
      SET_BED_TEMPERATURE TARGET=60
      BED_TEMPERATURE_WAIT MINIMUM=58 MAXIMUM=65
      CG28
      SCREWS_TILT_CALCULATE

[gcode_macro Calibrate_Probe_Z_Offset]
gcode:
      CG28
      PROBE_CALIBRATE
      
[gcode_macro Auto_Full_Bed_Level]
gcode:
      RESPOND PREFIX="info" MSG="Running Custom Bed Leveling Macro"
      CG28
      BED_MESH_CLEAR
      SET_BED_TEMPERATURE TARGET=60
      BED_TEMPERATURE_WAIT MINIMUM=58 MAXIMUM=65
      CG28
      #BED_MESH_CALIBRATE METHOD=scan SCAN_MODE=rapid
      BED_MESH_CALIBRATE METHOD=rapid_scan

#############################################################################
#   PID Tuning Macros
#############################################################################

[gcode_macro PID_Tune_EXTRUDER]
gcode:
  {% set temperature = params.TEMPERATURE|default(210) %}
  CG28
  M106 S255
  PID_CALIBRATE HEATER=extruder TARGET={temperature}
  SAVE_CONFIG

[gcode_macro PID_Tune_BED]
gcode:
  {% set temperature = params.TEMPERATURE|default(60) %}
  CG28
  M106 S255 ;Sets Print Fans to 100%
  PID_CALIBRATE HEATER=heater_bed TARGET={temperature}
  SAVE_CONFIG
  

#############################################################################
#   SPI Accelerometer Config
#############################################################################    
      
[mcu rpi]
serial: /tmp/klipper_host_mcu

[adxl345 x]
cs_pin: rpi:None
spi_bus: spidev0.0
axes_map: x,z,-y

[adxl345 y]
cs_pin: rpi:None
spi_bus: spidev0.1
axes_map: -x,-y,-z

[resonance_tester]
accel_chip_x: adxl345 x
accel_chip_y: adxl345 y
max_smoothing: 0.15
probe_points:
    162.5, 162.5, 20

#############################################################################
#   Input Shaper Config
#############################################################################

[input_shaper]
#shaper_type_x: mzv
#shaper_freq_x: 28.4
#shaper_type_y: mzv
#shaper_freq_y: 28.4

[shaketune]
result_folder: ~/printer_data/config/ShakeTune_results
#    The folder where the results will be stored. It will be created if it doesn't exist.
number_of_results_to_keep: 3
#    The number of results to keep in the result_folder. The oldest results will
#    be automatically deleted after each runs.
# keep_raw_csv: False
#    If True, the raw CSV files will be kept in the result_folder alongside the
#    PNG graphs. If False, they will be deleted and only the graphs will be kept.
show_macros_in_webui: True
#    Mainsail and Fluidd doesn't create buttons for "system" macros that are not in the
#    printer.cfg file. If you want to see the macros in the webui, set this to True.
# timeout: 300
#    The maximum time in seconds to let Shake&Tune process the CSV files and generate the graphs.

#############################################################################

[include user_settings.cfg]     ; Users custom macros 

[firmware_retraction]
retract_length: 0.5
# The length of filament (in mm) to retract when G10 is activated,
# and to unretract when G11 is activated (but see
# unretract_extra_length below). The default is 0 mm.
retract_speed: 80
# The speed of retraction, in mm/s. The default is 20 mm/s.
unretract_extra_length: 0
# The length (in mm) of *additional* filament to add when
# unretracting.
unretract_speed: 80
# The speed of unretraction, in mm/s. The default is 10 mm/s.

#############################################################################

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# pid_kp = 29.695
#*# pid_ki = 7.332
#*# pid_kd = 30.066
#*# control = pid
#*#
#*# [heater_bed]
#*# pid_kp = 72.676
#*# pid_ki = 1.170
#*# pid_kd = 1128.298
#*# control = pid
#*#
#*# [input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 60.4
#*# shaper_type_y = mzv
#*# shaper_freq_y = 27.0
#*#
#*# [axis_twist_compensation]
#*# z_compensations = 0.014868, -0.024016, 0.009148
#*# compensation_start_x = 25.0
#*# compensation_end_x = 295.0
#*#
#*# [probe_eddy_current btt_eddy]
#*# reg_drive_current = 16
#*# calibrate =
#*# 	0.050000:3194360.148,0.090000:3193367.001,0.130000:3192402.059,
#*# 	0.170000:3191392.990,0.210000:3190431.809,0.250000:3189426.364,
#*# 	0.290000:3188482.155,0.330000:3187499.769,0.370000:3186583.983,
#*# 	0.410000:3185623.394,0.450000:3184728.810,0.490000:3183786.137,
#*# 	0.530000:3182895.269,0.570000:3181976.453,0.610000:3181137.646,
#*# 	0.650000:3180246.835,0.690000:3179395.818,0.730000:3178538.607,
#*# 	0.770000:3177736.772,0.810000:3176876.840,0.850000:3176121.054,
#*# 	0.890000:3175290.795,0.930000:3174533.811,0.970000:3173757.001,
#*# 	1.010000:3173000.885,1.050000:3172259.377,1.090000:3171536.282,
#*# 	1.130000:3170807.805,1.170000:3170102.198,1.210000:3169379.031,
#*# 	1.250000:3168730.423,1.290000:3168027.629,1.330000:3167377.953,
#*# 	1.370000:3166710.526,1.410000:3166092.384,1.450000:3165454.033,
#*# 	1.490000:3164860.904,1.530000:3164213.862,1.570000:3163637.449,
#*# 	1.610000:3163052.291,1.650000:3162467.228,1.690000:3161900.988,
#*# 	1.730000:3161347.743,1.770000:3160788.993,1.810000:3160252.322,
#*# 	1.850000:3159708.448,1.890000:3159209.091,1.930000:3158683.598,
#*# 	1.970000:3158197.761,2.010000:3157676.405,2.050000:3157216.259,
#*# 	2.090000:3156738.773,2.130000:3156288.248,2.170000:3155801.609,
#*# 	2.210000:3155363.359,2.250000:3154895.261,2.290000:3154488.457,
#*# 	2.330000:3154044.142,2.370000:3153619.189,2.410000:3153198.054,
#*# 	2.450000:3152809.084,2.490000:3152393.557,2.530000:3152014.997,
#*# 	2.570000:3151612.707,2.610000:3151243.682,2.650000:3150854.470,
#*# 	2.690000:3150506.057,2.730000:3150153.832,2.770000:3149786.879,
#*# 	2.810000:3149439.564,2.850000:3149100.160,2.890000:3148746.593,
#*# 	2.930000:3148428.969,2.970000:3148106.466,3.010000:3147792.462,
#*# 	3.050000:3147459.895,3.090000:3147162.182,3.130000:3146851.627,
#*# 	3.170000:3146556.378,3.210000:3146260.167,3.250000:3145981.261,
#*# 	3.290000:3145694.134,3.330000:3145431.459,3.370000:3145165.516,
#*# 	3.410000:3144876.119,3.450000:3144605.818,3.490000:3144378.843,
#*# 	3.530000:3144092.115,3.570000:3143845.255,3.610000:3143618.142,
#*# 	3.650000:3143374.692,3.690000:3143121.732,3.730000:3142901.418,
#*# 	3.770000:3142671.434,3.810000:3142421.940,3.850000:3142223.012,
#*# 	3.890000:3142010.672,3.930000:3141777.409,3.970000:3141576.171,
#*# 	4.010000:3141357.662,4.050000:3141132.456
#*# calibration_temp = 46.617749
#*# z_offset = 2
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.059522, 0.055594, 0.050140, 0.074802, 0.126113, 0.135595, 0.106650, 0.079218, 0.072418, 0.091697
#*# 	0.054208, 0.038097, 0.029233, 0.050773, 0.080937, 0.091152, 0.076153, 0.051169, 0.042437, 0.059180
#*# 	0.042091, 0.014079, 0.004271, 0.015770, 0.046220, 0.065630, 0.054259, 0.034783, 0.025073, 0.052733
#*# 	0.053378, 0.014490, 0.001049, 0.002261, 0.028093, 0.043464, 0.049453, 0.035091, 0.031721, 0.050374
#*# 	0.052075, 0.009295, -0.006597, -0.008547, 0.007005, 0.019936, 0.036108, 0.035070, 0.042482, 0.055467
#*# 	0.055922, 0.013971, -0.016552, -0.027401, -0.018932, 0.013855, 0.022589, 0.032955, 0.041103, 0.070923
#*# 	0.062217, 0.006148, -0.034331, -0.050986, -0.038810, -0.007429, 0.008449, 0.026735, 0.040036, 0.076151
#*# 	0.060305, 0.009814, -0.030216, -0.052383, -0.049179, -0.026455, 0.001415, 0.026213, 0.043216, 0.094942
#*# 	0.052185, -0.007679, -0.053038, -0.082337, -0.078035, -0.060656, -0.035852, -0.003231, 0.027563, 0.075505
#*# 	0.039289, -0.017883, -0.077044, -0.104029, -0.118442, -0.104157, -0.071322, -0.040166, -0.009440, 0.035033
#*# x_count = 10
#*# y_count = 10
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 19.0
#*# max_x = 292.96000000000004
#*# min_y = 37.0
#*# max_y = 309.9699999999999
#*#
#*# [skew_correction lantern_profile_1]
#*# xy_skew = 0.06056917474366685
#*# xz_skew = -0.0018384920535402098
#*# yz_skew = -0.0043699530413906
#*#
#*# [temperature_probe btt_eddy]
#*# calibration_temp = 43.052085
